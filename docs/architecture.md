# PomodoroFlow-Rs 架构设计

## 架构概述

PomodoroFlow-Rs 采用**分层架构**和**事件驱动**的设计模式，基于 Tauri 框架实现跨平台桌面应用。应用拆分为清晰分离的模块，实现高内聚、低耦合的目标。

### 核心原则

1. **关注点分离**: 前端UI、后端业务逻辑、数据存储严格分离
2. **异步优先**: 所有 I/O 操作异步化，不阻塞 UI
3. **错误恢复**: 完善的错误处理和自动恢复机制
4. **状态集中**: 全局状态管理，保证数据一致性
5. **本地优先**: 数据存储在本地 SQLite，无需网络依赖

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend Layer                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │  React + TSX     │  │   Zustand        │  │   Custom CSS   │ │
│  │   (Components)   │  │   (State Mgmt)   │  │   (Styling)    │ │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬───────┘ │
└───────────┼──────────────────────┼──────────────────────┼─────────┘
            │                      │                      │
            │            invoke()    │                      │
            │──────────────────────┼──────────────────────│
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Tauri Backend                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │  Command         │  │   Event          │  │   Window       │ │
│  │  Handlers        │  │   System         │  │   Management   │ │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬───────┘ │
└───────────┼──────────────────────┼──────────────────────┼─────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Core Library (Rust)                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │ PomodoroService  │  │   TodoService    │  │  AppState      │ │
│  │  (Timer Logic)   │  │  (CRUD + Local)  │  │   Manager      │ │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬───────┘ │
└───────────┼──────────────────────┼──────────────────────┼─────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Data Layer                                │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────┐ │
│  │   Database       │  │   File System    │  │   Config       │ │
│  │   (SQLite)       │  │   (Data Dir)     │  │   Manager      │ │
│  └──────────────────┘  └──────────────────┘  └────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 架构组件详解

### 1. 前端层 (Frontend Layer)

**技术栈**: React 18 + TypeScript + Vite + 自定义 CSS

**核心组件**:
- `PomodoroTimer.tsx` - 番茄钟计时器组件
- `TodoList.tsx` - 待办事项列表组件
- `SettingsPanel.tsx` - 设置面板组件
- `ThemeToggle.tsx` - 主题切换组件
- `MessageToast.tsx` - 消息提示组件

**状态管理**:
- Zustand 用于全局状态管理
- 前端状态与后端通过 Tauri bridge 同步

### 2. Tauri 后端 (Tauri Backend)

**技术栈**: Rust + Tauri API

**核心模块**:
- `commands/` - 命令处理器，暴露给前端调用
  - `todo_commands.rs` - Todo CRUD 操作
  - `pomodoro_commands.rs` - 番茄钟控制
  - `config_commands.rs` - 配置管理
  - `system_commands.rs` - 系统功能

**事件系统**:
- 前端通过 `invoke()` 调用后端命令
- 后端通过 `emit()` 向前端发送事件
- 支持实时状态更新（如番茄钟倒计时）

### 3. 核心库 (Core Library)

**技术栈**: Rust + Tokio + SQLite

**核心服务**:
- `PomodoroService` - 番茄钟计时逻辑
- `TodoService` - 待办事项管理（本地模式）
- `AppStateManager` - 全局状态管理
- `Database` - SQLite 数据访问层
- `TaskManager` - 异步任务管理

### 4. 数据层 (Data Layer)

**技术栈**: SQLite + 文件系统

**数据表**:
- `todos` - 待办事项
- `user_config` - 用户配置
- `pomodoro_sessions` - 番茄钟会话记录

## 启动流程

```
1. 程序启动 (main.rs)
   ↓
2. 初始化 Panic Hook
   ↓
3. 创建 Tauri Builder
   ↓
4. Tauri Setup (前端窗口创建)
   ↓
5. 异步初始化核心服务
   ├─ 创建数据库连接
   ├─ 加载用户配置
   ├─ 初始化状态管理器
   └─ 启动后台任务
   ↓
6. 注册命令处理器
   ↓
7. 前端加载完成
```

## 数据流

### 番茄钟计时流程
```
用户点击开始
  ↓
前端 invoke(start_pomodoro)
  ↓
后端命令处理器
  ↓
PomodoroService.start()
  ↓
启动后台计时任务
  ↓
每秒发出 pomodoro-tick 事件
  ↓
前端更新 UI
```

### 任务创建流程
```
用户输入任务
  ↓
前端 invoke(create_todo)
  ↓
后端验证数据
  ↓
Database.create_todo() (异步)
  ↓
返回创建的任务
  ↓
前端更新状态
```

## 错误处理

### 分层错误处理
1. **前端**: 用户友好的错误提示
2. **命令层**: 结构化错误返回 `CommandResult<T>`
3. **核心层**: 详细错误日志
4. **数据库层**: ACID 事务保护

### 错误类型
- `ValidationError` - 输入验证失败
- `DatabaseError` - 数据库操作错误
- `NotFoundError` - 资源不存在
- `InvalidState` - 状态不合法

## 性能优化

### 启动优化
- **延迟初始化**: 非关键组件延迟加载
- **连接池**: 数据库连接复用
- **异步初始化**: 不阻塞 UI 线程

### 内存优化
- **资源管理**: 自动清理未使用的资源
- **懒加载**: 按需加载组件和数据
- **Arc/Mutex**: 线程安全的共享状态

### 响应优化
- **乐观更新**: UI 立即响应，后台同步
- **批量操作**: 减少数据库往返次数
- **预编译语句**: SQLite 查询优化

## 安全设计

### 数据安全
- 本地 SQLite 数据存储
- 用户数据保存在用户目录
- 配置文件权限保护

### 输入验证
- 命令参数严格验证
- SQL 注入防护（参数化查询）
- XSS 防护（React 转义）

## 扩展性设计

### 模块化
- 清晰的模块边界
- 依赖注入模式
- 可插拔组件设计

### API 设计
- 统一的命令接口
- 版本兼容性保证
- 向后兼容策略

## 部署架构

### 开发环境
```
┌─────────────┐
│  Dev Server │
│ (Vite:1420) │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│   Tauri Dev     │
│   (Hot Reload)  │
└─────────────────┘
```

### 生产环境
```
┌─────────────────┐
│  Compiled App   │
│  (Single File)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   SQLite DB     │
│  (Local File)   │
└─────────────────┘
```

## 监控与诊断

### 启动监控
- 启动时间详细记录
- 各阶段耗时分析
- 超时自动告警

### 错误监控
- Panic 日志记录
- 崩溃报告生成
- 错误堆栈跟踪

## 总结

当前架构基于 Tauri 实现了简洁、高效的桌面应用方案，具备以下特点：

✅ **简洁**: 单架构设计，维护成本低
✅ **高效**: 启动时间 < 5秒，内存占用 < 150MB
✅ **可靠**: 完善的错误处理和数据保护
✅ **可扩展**: 模块化设计，支持未来功能扩展
✅ **跨平台**: Windows/macOS/Linux 一套代码

该架构为 PomodoroFlow-Rs 提供了坚实的技术基础，支持快速迭代和长期维护。
